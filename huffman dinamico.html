<head>
<script>
function codigoDeCaracter(arbol,caracter){
	if (arbol.hijos.length==0) return "_"
	var arbol0 = arbol.hijos[0]
	var arbol1 = arbol.hijos[1]
	if (arbol0.hijos.length==0){
		if(arbol0.c==caracter) return "0"
	}else{
		var resCompresion = codigoDeCaracter(arbol0,caracter)
		if(resCompresion.indexOf("#")==-1){
			return "0"+resCompresion
		}
	}
	
	if (arbol1.hijos.length==0){
		if(arbol1.c==caracter) return "1"
	}else{
		var resCompresion = codigoDeCaracter(arbol1,caracter)
		if(resCompresion.indexOf("#")==-1){
			return "1"+resCompresion
		}
	}
	
	return "#"
}
function mejorarArbol(arbol,desempatador){
	arbol.hijos.sort(function(a,b){
			var posta =a.p-b.p
			if (posta == 0) return desempatador(a,b)
			return posta
		})
	arbol.hijos.reverse()
	var len = arbol.hijos.length
	var h0 = arbol.hijos[len-2]
	var h1 = arbol.hijos[len-1]
	arbol.hijos.splice(len-2,2)
	var arbolito = {p:h0.p+h1.p, hijos:[h0,h1]}
	arbol.hijos.push(arbolito)
	return arbol
}
function construirArbolDeCaracteres(tabla){
	var arbol={hijos:[]}
	for (var prop in tabla){
		if (tabla.hasOwnProperty(prop)){
			arbol.hijos.push({c:prop, p:tabla[prop], hijos:[]})//c: caracter, p:puntaje
		}
	}
	//console.log("------------------------ inicia while")
	while(arbol.hijos.length>2){
		mejorarArbol(arbol,function(c1,c2){
			while (c1.hijos.length != 0) c1 = c1.hijos[0]
			while (c2.hijos.length != 0) c2 = c2.hijos[0]	
			if (c1<c2) return -1
			return 1
		})
	}
	//console.log(arbol)
	return arbol
}
function comprimirCaracterHuffmanDinamico(caracter,tablaDeFrecuencias){
	var arbol = construirArbolDeCaracteres(tablaDeFrecuencias)
	return codigoDeCaracter(arbol,caracter)
}
function copiarTablaDeFrecuencias(tabla){
	var copia ={}
	for (var p in tabla){
		if( tabla.hasOwnProperty(p)){
			copia[p] = tabla[p]
		}
	}
	return copia
}

function huffmanDinamico(entrada,conDetalles){
	//archivoFinal es el archivo que queda
	//tablasDeFrecuencias es cómo está la tabla a cada momento
	
	//inicializar tabla de frecuencias
	var tablasDeFrecuencias=[]
	var tablaDeFrecuencias={}
	console.log("----iniciando compresión-------")
	var archivoFinal =""
	for(var pos=0; pos<entrada.length; pos+=1){
		var caracter = entrada[pos]
		
		if(tablaDeFrecuencias.hasOwnProperty(caracter)){
			tablaDeFrecuencias[caracter]+=1
		}else{
			tablaDeFrecuencias[caracter]=1
		}
		var copia = copiarTablaDeFrecuencias(tablaDeFrecuencias)
		tablasDeFrecuencias.push(copia)
		
		if(conDetalles){
			archivoFinal += caracter+comprimirCaracterHuffmanDinamico(caracter,tablaDeFrecuencias)+" "
		}else{
			archivoFinal += comprimirCaracterHuffmanDinamico(caracter,tablaDeFrecuencias)
		}
	}
	return {archivoFinal:archivoFinal,tablasDeFrecuencias:tablasDeFrecuencias}
	
}
function obtenerAbecedario(fuente){
	var abecedario =""
	for(var pos=0; pos<fuente.length; pos+=1){
		caracter = fuente[pos]
		if (abecedario.indexOf(caracter)==-1){
			abecedario += caracter
		}
	}
	return abecedario
}
function cambiarVisibilidadPanel(contenedor){
	var panel = contenedor.children["panel"]
	var link = contenedor.children["link"]
	if(panel.style.display=="block"){
		panel.style.display = "none"
		link.innerHTML=">expandir"
	}else{
		panel.style.display = "block"
		link.innerHTML=">achicar"
	}
}
function generarPanel(entrada,nCaracter,tablaDeFrecuencias){
	//generar el nombe
	var nombrePanel=""
	nombrePanel += entrada.slice(0,nCaracter)//antes de nCaracter
	nombrePanel += "<u>"+entrada[nCaracter]+"</u>"//el caracter resaltado
	nombrePanel += entrada.slice(nCaracter+1,entrada.length)//después de nCaracter
	//generar la tabla
	var sTabla="<table style=\"border:2px solid red\">"+
		"<tr>"+
			"<th>caracter</th>"+
			"<th>frecuencia/cantidad/puntaje</th>"+
		"</tr>"
	for(var p in tablaDeFrecuencias){
		if( tablaDeFrecuencias.hasOwnProperty(p)){
			sTabla+="<tr>"+
				"<td>"+p+"</td>"+
				"<td>"+tablaDeFrecuencias[p]+"</td>"+
			"</tr>"
		}
	}
	sTabla+="</table>"
	var izquierda = sTabla
	var derecha="<img src=\"http://i1.kym-cdn.com/entries/icons/original/000/000/045/n725075089_288918_2774.jpg\">"
	var contenido="<div id=\"wrapper\" style=\"display:flex\"><div>"+izquierda+"</div><div>"+derecha+"</div> </div>"
	return "<div>"+
		"<head><a id='link' href='javascript:void(0)' onclick='cambiarVisibilidadPanel(this.parentElement)'>>expandir</a>  "+nombrePanel+"</head>"+
		"<body><div id='panel' style=\"display:none;\">"+contenido+"</div></body>"+
		"</div>"
	/*
	LO QUE TENGO QUE METER ADENTRO: UN TAG CANVAS Y DESPUES HAGO
	var my_canvas = document.getElementById("canvas")
	var context = my_canvas.getContext("2d")
	context.moveTo()....
	context.lineTo()...
	Y PARA DIBUJAR LO QUE QUIERA:
	http://www.w3schools.com/tags/ref_canvas.asp
	*/
}
function generarPaneles(contenedor,entrada,tablas){
	contenedor.innerHTML =""
	for(var i=0; i<entrada.length; i++){
		contenedor.innerHTML+=generarPanel(entrada,i,tablas[i])
		console.log(tablas[i])
	}
}
function cambiaEntrada(){
	var entrada=document.getElementById("archivoEntrada").value
	//abecedario = obtenerAbecedario(entrada)//document.getElementById("conjuntoCaracteres").value
	//document.getElementById("conjuntoCaracteres").innerHTML = abecedario
	var detalles = document.getElementById("conDetalles").checked
	var salida = huffmanDinamico(entrada, detalles)
	document.getElementById("archivoSalida").innerHTML = salida.archivoFinal
	var contienePaneles = document.getElementById("contienePaneles")
	generarPaneles(contienePaneles,entrada,salida.tablasDeFrecuencias)
	//<p><button type="button" onclick="joda(0)" type ="button">Contarle a tus amigos</button></p>
}
</script>

HUFFMAN DINAMICO
</head>
<body>
	<p>Calculadora de Huffman Dinamico</p>
	<p>archivo a comprimir  <input id="archivoEntrada" type ="text" 
		onchange="cambiaEntrada()"
		onclick="cambiaEntrada()"
		oninput="cambiaEntrada()"
		onkeydown="cambiaEntrada()"
		onkeyup="cambiaEntrada()"
		onpaste="cambiaEntrada()"
		onpropertychange="cambiaEntrada()"
		onkeypress="cambiaEntrada()"></input></p>
	<p>Archivo comprimido <u>(falta fin de archivo)</u>:<i id="archivoSalida">_</i></p>
	<p>Agregar detalle de como queda comprimido cada caracter <input id = "conDetalles" onclick="cambiaEntrada()" type = "checkbox"></p>
	<div id="contienePaneles"></div>
	<p></p>
	<p></p>
	<p></p>
	<p></p>
	
</body>